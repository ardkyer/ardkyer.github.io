<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ site.title }}</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css' rel='stylesheet' />
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{ '/assets/main.css' | relative_url }}">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js'></script>
</head>

<body>
    <div class="page-container">
        <div class="content-wrap">
            {% include header.html %}

            <div id="search-container">
                <input type="text" id="search-input" placeholder="검색...">
                <button id="search-button" onclick="search()">검색</button>
                <div id="results-container"></div>
            </div>
            <main>
                {{ content }}
            </main>
        </div>

        <footer>
            <p>&copy; {{ site.time | date: '%Y' }} {{ site.title }}</p>
        </footer>
    </div>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (typeof mermaid !== 'undefined') {
                console.log("Mermaid is loaded");
                mermaid.initialize({
                    startOnLoad: true,
                    theme: 'default',
                    securityLevel: 'loose'
                });
                console.log("Mermaid initialized");
            } else {
                console.error("Mermaid is not loaded");
            }
        });

        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="https://unpkg.com/lunr/lunr.js"></script>
    <script>
        var posts = [
            {% for post in site.posts %}
        {
            "title": "{{ post.title | escape }}",
                "url": "{{ site.baseurl }}{{ post.url }}",
                    "date": "{{ post.date }}",
                        "content": "{{ post.content | strip_html | strip_newlines | escape }}"
        } {% unless forloop.last %}, {% endunless %}
        {% endfor %}
        ];

        function formatDate(dateString) {
            var date = new Date(dateString);
            var year = date.getFullYear();
            var month = ('0' + (date.getMonth() + 1)).slice(-2);
            var day = ('0' + date.getDate()).slice(-2);
            return year + '-' + month + '-' + day;
        }

        function search() {
            var query = document.getElementById("search-input").value.toLowerCase();
            var resultsContainer = document.getElementById("results-container");
            resultsContainer.innerHTML = "";

            var results = posts.filter(function (post) {
                return post.title.toLowerCase().includes(query) ||
                    post.content.toLowerCase().includes(query);
            });

            if (results.length === 0) {
                resultsContainer.innerHTML = "<p>검색 결과가 없습니다.</p>";
            } else {
                results.forEach(function (post) {
                    var div = document.createElement("div");
                    div.className = "search-result";

                    var h3 = document.createElement("h3");
                    var a = document.createElement("a");
                    a.href = post.url;
                    a.innerHTML = highlightText(post.title, query);
                    h3.appendChild(a);
                    div.appendChild(h3);

                    var date = document.createElement("p");
                    date.textContent = "작성일: " + formatDate(post.date);
                    div.appendChild(date);

                    var snippet = post.content.toLowerCase().indexOf(query);
                    if (snippet !== -1) {
                        var p = document.createElement("p");
                        p.innerHTML = "..." + highlightText(post.content.substring(Math.max(0, snippet - 50), snippet + query.length + 50), query) + "...";
                        div.appendChild(p);
                    }

                    resultsContainer.appendChild(div);
                });
            }
        }

        function highlightText(text, query) {
            var regex = new RegExp("(" + query + ")", "gi");
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        document.getElementById("search-input").addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
                search();
            }
        });
    </script>
</body>

</html>